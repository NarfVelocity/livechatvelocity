<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>LiveChat Account Context</title>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 12px;
      font-size: 14px;
    }
    #status {
      margin-bottom: 8px;
      font-weight: bold;
    }
    pre {
      background: #f5f5f5;
      padding: 8px;
      max-height: 400px;
      overflow: auto;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>

<h3>LiveChat Account Context</h3>
<div id="status">Initializing…</div>
<pre id="output">(waiting for data)</pre>

<script>
  const statusEl = document.getElementById("status");
  const outputEl = document.getElementById("output");

  let initialized = false;

  function log(label, value) {
    console.log("[LiveChat Widget]", label, value);
    outputEl.textContent =
      label + ":\n" + JSON.stringify(value, null, 2);
  }

  window.addEventListener("message", (event) => {
    if (!event.origin.includes("livechatinc.com")) return;

    const msg = event.data;

    // 1️⃣ Handshake arrives repeatedly — we only react ONCE
    if (msg?.type === "handshake" && !initialized) {
      initialized = true;
      statusEl.textContent = "Connected — requesting chat context";

      event.source.postMessage(
        {
          "@@livechat/postmessenger": true,
          type: "get_chat"
        },
        event.origin
      );

      return;
    }

    // 2️⃣ Chat data response
    if (msg?.type === "chat") {
      statusEl.textContent = "Chat context received ✅";
      log("Chat", msg.data);
      return;
    }

    // 3️⃣ Customer profile response
    if (msg?.type === "customer_profile") {
      statusEl.textContent = "Customer profile received ✅";
      log("Customer profile", msg.data);
      return;
    }
  });

  statusEl.textContent = "Waiting for LiveChat…";
</script>

</body>
</html>
