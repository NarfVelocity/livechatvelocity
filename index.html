<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>LiveChat Account Context</title>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 12px;
      font-size: 14px;
      background: #fff;
    }
    h3 {
      margin-top: 0;
    }
    #status {
      margin-bottom: 10px;
      font-weight: bold;
    }
    pre {
      background: #f5f5f5;
      padding: 8px;
      max-height: 400px;
      overflow: auto;
      white-space: pre-wrap;
      border-radius: 4px;
    }
  </style>
</head>

<body>

  <h3>LiveChat Account Context</h3>
  <div id="status">Waiting for LiveChat‚Ä¶</div>
  <pre id="output">(no data yet)</pre>

  <script>
    const statusEl = document.getElementById("status");
    const outputEl = document.getElementById("output");

    let initialized = false;

    function log(label, value) {
      console.log(`[LiveChat Widget] ${label}`, value);
      outputEl.textContent =
        `${label}:\n${JSON.stringify(value, null, 2)}`;
    }

    window.addEventListener("message", (event) => {
      // Only accept messages from LiveChat Agent App
      if (!event.origin.includes("livechatinc.com")) return;

      const data = event.data;

      // Ignore unrelated messages
      if (!data || data["@@livechat/postmessenger"] !== true) return;

      console.log("[LiveChat Widget] received", data);

      // 1Ô∏è‚É£ Handshake
      if (data.type === "handshake" && !initialized) {
        initialized = true;

        statusEl.textContent = "Connected to LiveChat ‚úÖ";

        // üîë REQUIRED: tell LiveChat we are ready
        event.source.postMessage(
          {
            "@@livechat/postmessenger": true,
            type: "ready"
          },
          event.origin
        );

        // üîî Subscribe to data streams
        event.source.postMessage(
          {
            "@@livechat/postmessenger": true,
            type: "subscribe",
            subscriptions: ["chat", "customer_profile"]
          },
          event.origin
        );

        return;
      }

      // 2Ô∏è‚É£ Chat data (pre-chat form, tags, etc.)
      if (data.type === "chat") {
        statusEl.textContent = "Chat context received";
        log("Chat", data.data);
        return;
      }

      // 3Ô∏è‚É£ Customer profile (email, name, location)
      if (data.type === "customer_profile") {
        statusEl.textContent = "Customer profile received";
        log("Customer profile", data.data);
        return;
      }
    });

    statusEl.textContent = "Listening for LiveChat messages‚Ä¶";
  </script>

</body>
</html>
