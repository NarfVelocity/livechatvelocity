<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Account Context Widget</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 12px;
    }
    pre {
      background: #f5f5f5;
      padding: 8px;
      overflow: auto;
    }
  </style>
</head>
<body>

<h3>LiveChat Account Context</h3>
<div id="status">Waiting for LiveChatâ€¦</div>
<pre id="output"></pre>

<script>
  const statusEl = document.getElementById("status");
  const outputEl = document.getElementById("output");

  function log(label, value) {
    console.log(`[LiveChat Widget] ${label}`, value);
    outputEl.textContent += `${label}:\n${JSON.stringify(value, null, 2)}\n\n`;
  }

  window.addEventListener("message", (event) => {
    // Security check
    if (!event.origin.includes("livechatinc.com")) return;

    const data = event.data;
    log("Received message", data);

    // Detect handshake
    if (data?.type === "handshake") {
      statusEl.textContent = "Handshake received â€” requesting context";

      // ðŸ”‘ THIS IS THE IMPORTANT PART
      event.source.postMessage(
        {
          "@@livechat/postmessenger": true,
          type: "get_context"
        },
        event.origin
      );
    }

    // Context updates will arrive here
    if (data?.type === "context") {
      statusEl.textContent = "Context received âœ…";
      log("Context", data);
    }
  });

  statusEl.textContent = "Listening for LiveChat messagesâ€¦";
</script>

</body>
</html>
